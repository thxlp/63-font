<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autumn Login</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="login-style.css">
</head>
<body>

    <div class="background-scene">
        <div class="tree-blob big-tree"></div>
        <div class="tree-blob small-tree"></div>
        <div class="bird"></div>
    </div>

    <div class="login-container">
        <div class="login-card">
            
            <div class="header-icon">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="#8D5E5E" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" opacity="0.1"/>
                    <path d="M18.5 7.5C16 8 14 10.5 13 12.5C12.5 10 11 8 8 7.5" stroke="#7B2E2E" stroke-width="2" stroke-linecap="round"/>
                    <path d="M13 12.5L11 16" stroke="#7B2E2E" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <h1>SIGN IN</h1>
            </div>

            <form id="loginForm">
                <div id="message" class="message" style="display: none;"></div>
                
                <div class="input-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" required>
                </div>

                <div class="input-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required>
                </div>

                <button type="submit" class="btn-login" id="submitBtn">Login</button>
            </form>

            <div class="footer-links">
                <a href="#" class="forgot">Forgot password</a>
                <a href="register.html" class="signup">Sign Up</a>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3002/api/auth/signin';

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
        function showMessage(message, type = 'error') {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = message;
            messageDiv.style.display = 'block';
            messageDiv.className = `message ${type}`;
            
            if (type === 'success') {
                messageDiv.style.backgroundColor = '#d4edda';
                messageDiv.style.color = '#155724';
                messageDiv.style.borderColor = '#c3e6cb';
            } else {
                messageDiv.style.backgroundColor = '#f8d7da';
                messageDiv.style.color = '#721c24';
                messageDiv.style.borderColor = '#f5c6cb';
            }
        }

        function hideMessage() {
            document.getElementById('message').style.display = 'none';
        }

        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ form submission
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessage();

            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const submitBtn = document.getElementById('submitBtn');

            // Validation
            if (!username || !password) {
                showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                return;
            }

            // Disable button ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
            submitBtn.disabled = true;
            submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...';

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: username, // ‚úÖ Backend ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ 'email' field
                        username: username, // ‡∏™‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
                        password: password
                    })
                });

                let data;
                try {
                    data = await response.json();
                } catch (e) {
                    // ‡∏ñ‡πâ‡∏≤ response ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON
                    data = { message: response.statusText || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î' };
                }

                if (response.ok) {
                    // Login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                    console.log('=== Login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ===');
                    console.log('Response data:', data);
                    console.log('Response keys:', Object.keys(data));
                    
                    showMessage('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å...', 'success');
                    
                    // ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å token ‡∏à‡∏≤‡∏Å data.session.access_token (‡∏ï‡∏≤‡∏° backend guide)
                    let tokenToSave = null;
                    if (data.session && data.session.access_token) {
                        tokenToSave = data.session.access_token;
                        console.log('‚úì ‡∏û‡∏ö token ‡πÉ‡∏ô data.session.access_token');
                    } else if (data.token) {
                        tokenToSave = data.token;
                        console.log('‚úì ‡∏û‡∏ö token ‡πÉ‡∏ô data.token');
                    } else if (data.accessToken) {
                        tokenToSave = data.accessToken;
                        console.log('‚úì ‡∏û‡∏ö token ‡πÉ‡∏ô data.accessToken');
                    } else if (data.access_token) {
                        tokenToSave = data.access_token;
                        console.log('‚úì ‡∏û‡∏ö token ‡πÉ‡∏ô data.access_token');
                    }
                    
                    if (tokenToSave) {
                        localStorage.setItem('token', tokenToSave);
                        console.log('‚úì ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å token ‡∏•‡∏á localStorage:', tokenToSave.substring(0, 20) + '...');
                    } else {
                        console.warn('‚ö† ‡πÑ‡∏°‡πà‡∏û‡∏ö token ‡πÉ‡∏ô response');
                        console.warn('   Response structure:', data);
                    }
                    
                    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô localStorage
                    let userDataToSave = null;
                    
                    if (data.user) {
                        userDataToSave = data.user;
                        console.log('‚úì ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô data.user');
                    } else if (data.data) {
                        userDataToSave = data.data;
                        console.log('‚úì ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô data.data');
                    } else if (data.username || data.email || data.weight || data.height) {
                        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ field ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤ data ‡∏Ñ‡∏∑‡∏≠ userData
                        userDataToSave = data;
                        console.log('‚úì ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô data ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á');
                    }
                    
                    if (userDataToSave) {
                        localStorage.setItem('userData', JSON.stringify(userDataToSave));
                        localStorage.setItem('isLoggedIn', 'true');
                        console.log('‚úì ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏•‡∏á localStorage:', userDataToSave);
                        console.log('   Fields ‡πÉ‡∏ô userData:', Object.keys(userDataToSave));
                        
                        // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• weight, height, bmi, calories ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                        const hasBmiData = userDataToSave.weight !== undefined || 
                                          userDataToSave.height !== undefined || 
                                          userDataToSave.bmi !== undefined || 
                                          userDataToSave.calories !== undefined;
                        
                        console.log('üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• BMI:');
                        console.log('   weight:', userDataToSave.weight);
                        console.log('   height:', userDataToSave.height);
                        console.log('   bmi:', userDataToSave.bmi);
                        console.log('   calories:', userDataToSave.calories);
                        console.log('   ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• BMI:', hasBmiData ? '‚úì ‡∏°‡∏µ' : '‚úó ‡πÑ‡∏°‡πà‡∏°‡∏µ');
                        
                        // ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å user_id ‡∏à‡∏≤‡∏Å root level ‡∏Å‡πà‡∏≠‡∏ô (‡∏ï‡∏≤‡∏° backend guide)
                        // Backend ‡∏™‡πà‡∏á‡∏°‡∏≤: data.id, data.user_id, data.user.id, data.user.user_id
                        let userIdToSave = null;
                        console.log('üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏≤ user_id...');
                        console.log('   data.id:', data.id);
                        console.log('   data.user_id:', data.user_id);
                        console.log('   userDataToSave.id:', userDataToSave.id);
                        console.log('   userDataToSave.user_id:', userDataToSave.user_id);
                        
                        if (data.id) {
                            userIdToSave = data.id; // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö root level ‡∏Å‡πà‡∏≠‡∏ô
                            console.log('   ‚úì ‡∏û‡∏ö user_id ‡πÉ‡∏ô data.id');
                        } else if (data.user_id) {
                            userIdToSave = data.user_id; // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö root level
                            console.log('   ‚úì ‡∏û‡∏ö user_id ‡πÉ‡∏ô data.user_id');
                        } else if (userDataToSave.id) {
                            userIdToSave = userDataToSave.id;
                            console.log('   ‚úì ‡∏û‡∏ö user_id ‡πÉ‡∏ô userDataToSave.id');
                        } else if (userDataToSave.user_id) {
                            userIdToSave = userDataToSave.user_id;
                            console.log('   ‚úì ‡∏û‡∏ö user_id ‡πÉ‡∏ô userDataToSave.user_id');
                        } else if (userDataToSave.userId) {
                            userIdToSave = userDataToSave.userId;
                            console.log('   ‚úì ‡∏û‡∏ö user_id ‡πÉ‡∏ô userDataToSave.userId');
                        }
                        
                        if (userIdToSave) {
                            localStorage.setItem('userId', userIdToSave);
                            localStorage.setItem('user_id', userIdToSave); // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠
                            console.log('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å user_id ‡∏•‡∏á localStorage:', userIdToSave);
                            console.log('   localStorage.getItem("userId"):', localStorage.getItem('userId'));
                            console.log('   localStorage.getItem("user_id"):', localStorage.getItem('user_id'));
                            
                            // ‚úÖ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• BMI ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API profile ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å bmi_records
                            if (!hasBmiData && userIdToSave) {
                                console.log('üì° ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• BMI ‡πÉ‡∏ô login response - ‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å API profile');
                                try {
                                    const profileResponse = await fetch(
                                        `http://localhost:3002/api/auth/profile?user_id=${userIdToSave}`,
                                        {
                                            method: 'GET',
                                            headers: {
                                                'Content-Type': 'application/json'
                                            }
                                        }
                                    );
                                    
                                    if (profileResponse.ok) {
                                        const profileData = await profileResponse.json();
                                        console.log('‚úì ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å API profile:', profileData);
                                        
                                        // ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å profile ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö userData
                                        const updatedUserData = {
                                            ...userDataToSave,
                                            weight: profileData.weight !== undefined ? profileData.weight : userDataToSave.weight,
                                            height: profileData.height !== undefined ? profileData.height : userDataToSave.height,
                                            bmi: profileData.bmi !== undefined ? profileData.bmi : userDataToSave.bmi,
                                            calories: profileData.calories !== undefined ? profileData.calories : userDataToSave.calories
                                        };
                                        
                                        console.log('‚úì ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å profile:', updatedUserData);
                                        localStorage.setItem('userData', JSON.stringify(updatedUserData));
                                    } else {
                                        console.warn('‚ö† ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å API profile ‡πÑ‡∏î‡πâ:', profileResponse.status);
                                    }
                                } catch (profileError) {
                                    console.error('‚úó Error ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API profile:', profileError);
                                }
                            }
                        } else {
                            console.error('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö user_id ‡πÉ‡∏ô response!');
                            console.error('   üí° Backend ‡∏Ñ‡∏ß‡∏£‡∏™‡πà‡∏á user_id ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡∏µ‡πà data.id ‡∏´‡∏£‡∏∑‡∏≠ data.user_id');
                            console.error('   Response structure:', JSON.stringify(data, null, 2));
                        }
                    } else {
                        console.warn('‚ö† ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô response');
                    }
                    
                    // Redirect ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤ main.html ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 1.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API profile)
                    setTimeout(() => {
                        window.location.href = 'main.html';
                    }, 1500);
                } else {
                    // Login ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                    const errorMessage = data.message || data.error || '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
                    showMessage(errorMessage);
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Login';
                }
            } catch (error) {
                console.error('Login error:', error);
                showMessage('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Server ‡∏£‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà port 3002 ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Login';
            }
        });
    </script>

    <style>
        .message {
            padding: 12px;
            margin-bottom: 16px;
            border-radius: 8px;
            border: 1px solid;
            font-size: 14px;
            text-align: center;
        }
    </style>

</body>
</html>