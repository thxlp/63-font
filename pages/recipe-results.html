<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>recipe-results</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles/search-style.css">
</head>
<body>

    <div class="background-scene">
        <div class="leaf-float" style="top: 10%; left: 10%;"></div>
        <div class="leaf-float" style="top: 20%; right: 10%; transform: rotate(90deg);"></div>
        <div class="leaf-float" style="bottom: 40%; left: 5%; opacity: 0.5;"></div>
        
        <div class="mountain m-1"></div>
        <div class="mountain m-2"></div>
        <div class="mountain m-3"></div>
    </div>

    <div class="app-container">
        
        <nav class="top-nav">
            <a href="main.html" class="nav-item">Main</a>
            <a href="profile.html" class="nav-item">Profile</a>
        </nav>

        <div class="card-glass full-card" id="searchCard">

            <h4 class="section-title">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h4>
            
            <div class="card-top">
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£" onkeypress="if(event.key === 'Enter') searchRecipes()">
                    <button class="search-icon" onclick="searchRecipes()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                    </button>
                </div>
                <div class="loading-indicator" id="loadingIndicator" style="display: none;">
                    <div class="spinner-small"></div>
                    <span class="loading-text-small">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...</span>
                </div>
            </div>

            <div class="card-body-spacer">
                <div class="error" id="error" style="display: none;"></div>
                <div class="products-container" id="recipesContainer"></div>
                <div class="product-detail" id="recipeDetail"></div>
            </div>

            <div class="card-bottom">
                <button class="btn-back" onclick="history.back()">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
            </div>

        </div>

    </div>

    <!-- Floating Cart Button -->
    <a href="cart.html" class="fab-cart">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <path d="M16 10a4 4 0 0 1-8 0"></path>
        </svg>
        <span class="fab-badge" id="fabBadge" style="display: none;">0</span>
    </a>

    <script src="../scripts/cart.js"></script>
    <script>
        // ‡πÉ‡∏ä‡πâ backend endpoint ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Spoonacular API ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
        const BACKEND_API_BASE = 'http://localhost:3002/api';
        
        // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• recipe nutrition ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ global
        let recipeNutritionCache = {};

        async function searchRecipes() {
            const searchInput = document.getElementById('searchInput');
            const query = searchInput.value.trim();
            
            if (!query) {
                showError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤');
                return;
            }

            // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
            showLoadingIndicator(true);
            hideError();
            clearRecipes();
            
            // ‡∏¢‡∏∑‡∏î card ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
            expandCard();

            try {
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å backend endpoint ‡πÅ‡∏ó‡∏ô Spoonacular API ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
                const url = `${BACKEND_API_BASE}/recipes/search?query=${encodeURIComponent(query)}&number=20`;
                console.log('üì§ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏π‡∏ï‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£:', url);
                
                const response = await fetch(url);
                console.log('üì• Response status:', response.status, response.statusText);
                
                if (!response.ok) {
                    // ‡∏≠‡πà‡∏≤‡∏ô response text ‡∏Å‡πà‡∏≠‡∏ô (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ response body ‡∏ñ‡∏π‡∏Å consume)
                    const responseText = await response.text();
                    let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    let backendError = '';
                    
                    // ‡∏•‡∏≠‡∏á parse ‡πÄ‡∏õ‡πá‡∏ô JSON
                    try {
                        const errorData = JSON.parse(responseText);
                        backendError = errorData.error || errorData.message || errorData.error_message || '';
                        console.error('‚ùå Error response (JSON):', errorData);
                        if (backendError) {
                            errorMessage = backendError;
                        }
                    } catch (e) {
                        // ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON - ‡πÉ‡∏ä‡πâ text ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
                        console.error('‚ùå Error response (text):', responseText);
                        if (responseText) {
                            backendError = responseText.substring(0, 200);
                            errorMessage = backendError;
                        }
                    }
                    
                    // ‡πÅ‡∏™‡∏î‡∏á error message ‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢‡∏ï‡∏≤‡∏° status code
                    if (response.status === 400) {
                        if (backendError.includes('Query') || backendError.includes('query') || backendError.includes('required')) {
                            errorMessage = `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: ${backendError}`;
                        } else if (backendError) {
                            errorMessage = `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: ${backendError}`;
                        } else {
                            errorMessage = '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á - ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ backend endpoint /api/recipes/search ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ö parameter query';
                        }
                    } else if (response.status === 404) {
                        errorMessage = '‡πÑ‡∏°‡πà‡∏û‡∏ö endpoint - ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ backend ‡∏°‡∏µ endpoint GET /api/recipes/search';
                    } else if (response.status === 500) {
                        errorMessage = backendError || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå - ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö backend logs';
                    } else if (response.status === 402) {
                        errorMessage = backendError || 'Spoonacular API quota exceeded - ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö API key ‡∏´‡∏£‡∏∑‡∏≠ plan';
                    }
                    
                    console.error('‚ùå Final error message:', errorMessage);
                    throw new Error(errorMessage);
                }
                
                const data = await response.json();
                console.log('‚úÖ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:', data);
                
                if (!data.results || data.results.length === 0) {
                    const container = document.getElementById('recipesContainer');
                    container.innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£</p>';
                } else {
                    displayRecipes(data.results);
                }
                
            } catch (error) {
                console.error('‚ùå Recipe search error:', error);
                console.error('   Error message:', error.message);
                console.error('   Error stack:', error.stack);
                
                // ‡πÅ‡∏™‡∏î‡∏á error message ‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢
                let errorMessage = error.message;
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    errorMessage = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ - ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ backend ‡∏£‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà port 3002';
                }
                
                showError(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${errorMessage}`);
            } finally {
                showLoadingIndicator(false);
            }
        }
        
        function expandCard() {
            const card = document.getElementById('searchCard');
            card.classList.add('expanded');
        }
        
        function displayRecipes(recipes) {
            const container = document.getElementById('recipesContainer');
            container.innerHTML = '';

            // ‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
            const resultCount = document.createElement('div');
            resultCount.className = 'result-count';
            resultCount.textContent = `‡∏û‡∏ö ${recipes.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
            container.appendChild(resultCount);

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á grid container
            const grid = document.createElement('div');
            grid.className = 'products-grid';
            container.appendChild(grid);

            recipes.forEach(recipe => {
                const card = document.createElement('div');
                card.className = 'product-card';
                
                const imageUrl = recipe.image || 'https://via.placeholder.com/200?text=No+Image';

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                const isInCartRecipe = isInCart(`recipe-${recipe.id}`);
                const addToCartBtnClass = isInCartRecipe ? 'btn-add-to-cart added' : 'btn-add-to-cart';
                const addToCartBtnText = isInCartRecipe ? 
                    `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    <span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß</span>` :
                    `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    <span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</span>`;

                card.innerHTML = `
                    <img src="${imageUrl}" alt="${recipe.title}" class="product-image" onerror="this.src='https://via.placeholder.com/200?text=No+Image'">
                    <div class="product-info">
                        <div class="product-name">${recipe.title}</div>
                        <button class="btn-nutrition" onclick="getRecipeNutrition(${recipe.id}, '${recipe.title.replace(/'/g, "\\'").replace(/"/g, '&quot;')}', '${imageUrl.replace(/'/g, "\\'")}')">
                            
                            <span>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</span>
                        </button>
                        <button class="${addToCartBtnClass}" onclick="addRecipeToCartWithNutrition(${recipe.id}, '${recipe.title.replace(/'/g, "\\'").replace(/"/g, '&quot;')}', '${imageUrl.replace(/'/g, "\\'")}')" data-recipe-id="recipe-${recipe.id}">
                            ${addToCartBtnText}
                        </button>
                    </div>
                `;

                grid.appendChild(card);
            });
        }

        async function getRecipeNutrition(recipeId, recipeTitle, recipeImage) {
            showLoadingIndicator(true);
            hideError();
            
            try {
                // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏π‡∏ï‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ú‡πà‡∏≤‡∏ô backend endpoint
                const nutritionUrl = `${BACKEND_API_BASE}/recipes/${recipeId}/nutrition`;
                const infoUrl = `${BACKEND_API_BASE}/recipes/${recipeId}/information`;
                
                const [nutritionResponse, infoResponse] = await Promise.all([
                    fetch(nutritionUrl).catch(() => null),
                    fetch(infoUrl).catch(() => null)
                ]);
                
                let nutritionData = null;
                let recipeInfo = null;
                
                if (nutritionResponse && nutritionResponse.ok) {
                    const nutritionText = await nutritionResponse.text();
                    nutritionData = nutritionText;
                }
                
                if (infoResponse && infoResponse.ok) {
                    recipeInfo = await infoResponse.json();
                }
                
                displayRecipeDetail(recipeId, recipeTitle, recipeImage, nutritionData, recipeInfo);
                
            } catch (error) {
                showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ: ' + error.message);
                console.error('Nutrition error:', error);
            } finally {
                showLoadingIndicator(false);
            }
        }
        
        function displayRecipeDetail(recipeId, recipeTitle, recipeImage, nutritionData, recipeInfo) {
            const detailDiv = document.getElementById('recipeDetail');
            detailDiv.className = 'product-detail active';
            
            // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏ß‡πâ‡πÉ‡∏ô cache
            if (recipeInfo && recipeInfo.nutrition && recipeInfo.nutrition.nutrients) {
                const nutrients = recipeInfo.nutrition.nutrients;
                recipeNutritionCache[recipeId] = {
                    energy: nutrients.find(n => n.name === 'Calories')?.amount || 0,
                    energy_unit: 'kcal',
                    fat: nutrients.find(n => n.name === 'Fat')?.amount || 0,
                    fat_unit: 'g',
                    carbohydrates: nutrients.find(n => n.name === 'Carbohydrates')?.amount || 0,
                    carbohydrates_unit: 'g',
                    proteins: nutrients.find(n => n.name === 'Protein')?.amount || 0,
                    proteins_unit: 'g',
                    fiber: nutrients.find(n => n.name === 'Fiber')?.amount || 0,
                    fiber_unit: 'g',
                    salt: nutrients.find(n => n.name === 'Sodium')?.amount ? (nutrients.find(n => n.name === 'Sodium').amount / 1000) : 0, // ‡πÅ‡∏õ‡∏•‡∏á mg ‡πÄ‡∏õ‡πá‡∏ô g
                    salt_unit: 'g'
                };
            }
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            const isInCartRecipe = isInCart(`recipe-${recipeId}`);
            const addToCartBtnClass = isInCartRecipe ? 'btn-add-to-cart added' : 'btn-add-to-cart';
            const addToCartBtnText = isInCartRecipe ? 
                `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                <span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß</span>` :
                `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                <span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</span>`;
            
            let nutritionHtml = '';
            if (recipeInfo && recipeInfo.nutrition && recipeInfo.nutrition.nutrients) {
                const nutrients = recipeInfo.nutrition.nutrients;
                const importantNutrients = [
                    { name: 'Calories', th: '‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà', unit: 'kcal' },
                    { name: 'Carbohydrates', th: '‡∏Ñ‡∏≤‡∏£‡πå‡πÇ‡∏ö‡πÑ‡∏Æ‡πÄ‡∏î‡∏£‡∏ï', unit: 'g' },
                    { name: 'Fat', th: '‡πÑ‡∏Ç‡∏°‡∏±‡∏ô', unit: 'g' },
                    { name: 'Saturated Fat', th: '‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏≠‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß', unit: 'g' },
                    { name: 'Sugar', th: '‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•', unit: 'g' },
                    { name: 'Cholesterol', th: '‡∏Ñ‡∏≠‡πÄ‡∏•‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡∏≠‡∏•', unit: 'mg' },
                    { name: 'Sodium', th: '‡πÇ‡∏ã‡πÄ‡∏î‡∏µ‡∏¢‡∏°', unit: 'mg' },
                    { name: 'Protein', th: '‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô', unit: 'g' },
                    { name: 'Fiber', th: '‡πÑ‡∏ü‡πÄ‡∏ö‡∏≠‡∏£‡πå', unit: 'g' },
                    { name: 'Vitamin A', th: '‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô‡πÄ‡∏≠', unit: 'IU' },
                    { name: 'Vitamin E', th: '‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô‡∏≠‡∏µ', unit: 'mg' },
                    { name: 'Vitamin B1', th: '‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô‡∏ö‡∏µ1', unit: 'mg' },
                    { name: 'Vitamin B6', th: '‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô‡∏ö‡∏µ6', unit: 'mg' },
                    { name: 'Magnesium', th: '‡πÅ‡∏°‡∏Å‡∏ô‡∏µ‡πÄ‡∏ã‡∏µ‡∏¢‡∏°', unit: 'mg' },
                    { name: 'Phosphorus', th: '‡∏ü‡∏≠‡∏™‡∏ü‡∏≠‡∏£‡∏±‡∏™', unit: 'mg' },
                    { name: 'Manganese', th: '‡πÅ‡∏°‡∏á‡∏Å‡∏≤‡∏ô‡∏µ‡∏™', unit: 'mg' },
                    { name: 'Copper', th: '‡∏ó‡∏≠‡∏á‡πÅ‡∏î‡∏á', unit: 'mg' }
                ];
                
                const nutritionItems = importantNutrients.map(nutrient => {
                    const found = nutrients.find(n => n.name === nutrient.name);
                    if (found && found.amount > 0) {
                        return {
                            label: nutrient.th,
                            value: found.amount.toFixed(found.amount % 1 === 0 ? 0 : 1),
                            unit: nutrient.unit
                        };
                    }
                    return null;
                }).filter(item => item !== null);
                
                if (nutritionItems.length > 0) {
                    nutritionHtml = `
                        <div class="detail-section">
                            <h3>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£</h3>
                            <div class="nutrition-grid">
                                ${nutritionItems.map(item => `
                                    <div class="nutrition-item">
                                        <div class="nutrition-label">${item.label}</div>
                                        <div class="nutrition-value">${item.value} ${item.unit}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
            } else if (nutritionData) {
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ö structured ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ HTML widget
                nutritionHtml = `
                    <div class="detail-section">
                        <h3>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£</h3>
                        <div class="nutrition-widget-container">
                            ${nutritionData}
                        </div>
                    </div>
                `;
            }
            
            let ingredientsHtml = '';
            if (recipeInfo && recipeInfo.extendedIngredients) {
                ingredientsHtml = `
                    <div class="detail-section">
                        <h3>‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö</h3>
                        <ul class="ingredients-list">
                            ${recipeInfo.extendedIngredients.map(ing => `<li>${ing.original}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            let instructionsHtml = '';
            if (recipeInfo && recipeInfo.instructions) {
                // ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î HTML instructions
                let cleanInstructions = recipeInfo.instructions
                    .replace(/<[^>]*>/g, '') // ‡∏•‡∏ö HTML tags
                    .replace(/\n\s*\n/g, '\n') // ‡∏•‡∏ö‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ß‡πà‡∏≤‡∏á‡∏ã‡πâ‡∏≥
                    .trim();
                
                instructionsHtml = `
                    <div class="detail-section">
                        <h3>‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏≥</h3>
                        <div class="instructions-text">${cleanInstructions}</div>
                    </div>
                `;
            }
            
            detailDiv.innerHTML = `
                <button class="btn-close-detail" onclick="closeRecipeDetail()">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
                <div class="detail-header">
                    <div class="detail-image">
                        <img src="${recipeImage}" alt="${recipeTitle}" onerror="this.src='https://via.placeholder.com/300?text=No+Image'">
                    </div>
                    <div class="detail-info">
                        <h2 class="detail-title">${recipeTitle}</h2>
                        <button class="${addToCartBtnClass}" onclick="addRecipeToCart(${recipeId}, '${recipeTitle.replace(/'/g, "\\'").replace(/"/g, '&quot;')}', '${recipeImage.replace(/'/g, "\\'")}')" data-recipe-id="recipe-${recipeId}">
                            ${addToCartBtnText}
                        </button>
                    </div>
                </div>
                ${nutritionHtml}
                ${ingredientsHtml}
                ${instructionsHtml}
            `;
            
            detailDiv.scrollIntoView({ behavior: 'smooth' });
        }
        
        function closeRecipeDetail() {
            const detailDiv = document.getElementById('recipeDetail');
            detailDiv.className = 'product-detail';
        }
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏° recipe ‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£
        async function addRecipeToCartWithNutrition(recipeId, recipeTitle, recipeImage) {
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ô cache ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            let nutrition = recipeNutritionCache[recipeId];
            
            // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£ ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô
            if (!nutrition) {
                try {
                    showNotification('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£...');
                    const infoUrl = `${BACKEND_API_BASE}/recipes/${recipeId}/information`;
                    const infoResponse = await fetch(infoUrl);
                    
                    if (infoResponse.ok) {
                        const recipeInfo = await infoResponse.json();
                        if (recipeInfo && recipeInfo.nutrition && recipeInfo.nutrition.nutrients) {
                            const nutrients = recipeInfo.nutrition.nutrients;
                            nutrition = {
                                energy: nutrients.find(n => n.name === 'Calories')?.amount || 0,
                                energy_unit: 'kcal',
                                fat: nutrients.find(n => n.name === 'Fat')?.amount || 0,
                                fat_unit: 'g',
                                carbohydrates: nutrients.find(n => n.name === 'Carbohydrates')?.amount || 0,
                                carbohydrates_unit: 'g',
                                proteins: nutrients.find(n => n.name === 'Protein')?.amount || 0,
                                proteins_unit: 'g',
                                fiber: nutrients.find(n => n.name === 'Fiber')?.amount || 0,
                                fiber_unit: 'g',
                                salt: nutrients.find(n => n.name === 'Sodium')?.amount ? (nutrients.find(n => n.name === 'Sodium').amount / 1000) : 0,
                                salt_unit: 'g'
                            };
                            // ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô cache
                            recipeNutritionCache[recipeId] = nutrition;
                        }
                    }
                } catch (error) {
                    console.warn('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ:', error);
                }
            }
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á product object ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
            const recipeProduct = {
                id: `recipe-${recipeId}`,
                name: recipeTitle,
                brand: 'Recipe',
                image_url: recipeImage,
                nutriscore_grade: '',
                addedAt: new Date().toISOString(),
                nutrition: nutrition, // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤
                isRecipe: true
            };
            
            const added = addToCart(recipeProduct);
            const buttons = document.querySelectorAll(`button[data-recipe-id="recipe-${recipeId}"]`);
            
            if (added) {
                showNotification('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß');
                buttons.forEach(button => {
                    button.classList.add('added');
                    button.innerHTML = `
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                        <span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß</span>
                    `;
                });
            } else {
                showNotification('‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß');
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏° recipe ‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ (‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ô cache ‡πÅ‡∏•‡πâ‡∏ß)
        function addRecipeToCart(recipeId, recipeTitle, recipeImage) {
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å cache
            const nutrition = recipeNutritionCache[recipeId] || null;
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á product object ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
            const recipeProduct = {
                id: `recipe-${recipeId}`, // ‡πÄ‡∏û‡∏¥‡πà‡∏° prefix ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ä‡∏ô‡∏Å‡∏±‡∏ö product id
                name: recipeTitle,
                brand: 'Recipe',
                image_url: recipeImage,
                nutriscore_grade: '',
                addedAt: new Date().toISOString(),
                nutrition: nutrition, // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å cache
                isRecipe: true // ‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô recipe
            };
            
            const added = addToCart(recipeProduct);
            const buttons = document.querySelectorAll(`button[data-recipe-id="recipe-${recipeId}"]`);
            
            if (added) {
                showNotification('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß');
                buttons.forEach(button => {
                    button.classList.add('added');
                    button.innerHTML = `
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                        <span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß</span>
                    `;
                });
            } else {
                showNotification('‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß');
            }
        }
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #6D2121;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 1000;
                font-size: 14px;
                font-weight: 600;
                animation: slideDown 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideUp 0.3s ease';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 2000);
        }
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° CSS animation ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö notification
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideDown {
                from {
                    opacity: 0;
                    transform: translateX(-50%) translateY(-20px);
                }
                to {
                    opacity: 1;
                    transform: translateX(-50%) translateY(0);
                }
            }
            @keyframes slideUp {
                from {
                    opacity: 1;
                    transform: translateX(-50%) translateY(0);
                }
                to {
                    opacity: 0;
                    transform: translateX(-50%) translateY(-20px);
                }
            }
        `;
        document.head.appendChild(style);

        function showLoadingIndicator(show) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.style.display = show ? 'flex' : 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        function clearRecipes() {
            document.getElementById('recipesContainer').innerHTML = '';
        }

        // ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å URL parameter ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
        window.addEventListener('DOMContentLoaded', () => {
            updateCartBadge();
            
            const urlParams = new URLSearchParams(window.location.search);
            const query = urlParams.get('q');
            
            if (query) {
                document.getElementById('searchInput').value = query;
                expandCard();
                searchRecipes();
            }
        });
    </script>
</body>
</html>

